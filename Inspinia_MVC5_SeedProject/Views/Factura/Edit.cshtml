@model ERP_GMEDINA.Models.tbFactura
@using ERP_GMEDINA.Models

@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .validation-error {
        color: red;
        font-size: small;
    }

    .modal-lg {
        max-width: 100% !important;
    }

    .required:after {
        content: "*";
        color: red;
        padding-left: 5px;
    }

    @@media (min-width: 1200px) {
        .modal-xlg {
            width: 85%;
        }
    }
</style>
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
        <h2>Factura</h2>
    </div>
    <div class="col-sm-8">
        <div class="title-action">
            <a href="@Url.Action("Index","Factura")">Regresar</a>
        </div>
    </div>
</div>

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Editar Factura</h5>
                </div>
                <div class="ibox-content">

                    @using (Html.BeginForm("Edit", "Factura", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        @Html.AntiForgeryToken()

                        <div class="form-horizontal">

                            @Html.ValidationSummary(true)
                            @Html.HiddenFor(model => model.fact_Id)
                            @Html.Hidden("RedirectTo", Url.Action("Index", "Factura"))
                            @**Auditoria*@
                            @Html.HiddenFor(model => model.fact_UsuarioCrea)
                            @Html.HiddenFor(model => model.fact_FechaCrea)
                            @Html.HiddenFor(model => model.fact_UsuarioModifica)
                            @Html.HiddenFor(model => model.fact_FechaModifica)
                            @Html.HiddenFor(model => model.tbUsuario.usu_Nombres)
                            @Html.HiddenFor(model => model.tbUsuario.usu_Apellidos)
                            @Html.HiddenFor(model => model.tbUsuario1.usu_Nombres)
                            @Html.HiddenFor(model => model.tbUsuario1.usu_Apellidos)

                            <div class="form-group">
                                @Html.LabelFor(model => model.suc_Id, new { @class = " required control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.suc_Id, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.suc_Id)</span>
                                </div>
                                @Html.LabelFor(model => model.cja_Id, new { @class = "required control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.cja_Id, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.cja_Id)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.pemi_NumeroCAI, new { @class = "control-label required col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.pemi_NumeroCAI, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.pemi_NumeroCAI)</span>
                                </div>
                                @Html.LabelFor(model => model.fact_Codigo, new { @class = "control-label required col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.fact_Codigo, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.fact_Codigo)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.fact_Fecha, new { @class = "required control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.fact_Fecha, "{0:yyyy-MM-dd}", new { htmlAttributes = new { @class = "form-control", @readonly = "readonly", @id = "fechafacturaEdit" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.fact_Fecha)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.clte_Identificacion, new { @class = "control-label col-md-2", id = "label_identificacion" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.clte_Identificacion, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.clte_Identificacion)</span>
                                </div>
                                @Html.LabelFor(model => model.clte_Nombres, new { @class = "control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.clte_Nombres, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly" } })
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.clte_Nombres)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-lg-offset-2 col-md-4">
                                    <input id="tpi_Id" type="hidden" class="form-control" hid />
                                </div>
                                <div class="col-lg-offset-2 col-md-4">
                                    <input id="clte_Fecha" type="hidden" class="form-control" hidden />
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.fact_AlCredito, new { @class = "control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.fact_AlCredito)
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.fact_AlCredito)</span>
                                </div>
                                <div class="form-horizontal" name="Credito" id="Credito">
                                    @Html.LabelFor(model => model.fact_DiasCredito, new { @class = "control-label col-md-2" })
                                    <div class="col-md-4">
                                        @Html.EditorFor(model => model.fact_DiasCredito)
                                        <span class="validation-error"> @Html.ValidationMessageFor(model => model.fact_DiasCredito)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">Autorizar Descuento</label>
                                <div class="col-md-4">
                                    <input id="fact_AutorizarDescuento" type="checkbox" class="checkbox" />
                                </div>
                                @Html.LabelFor(model => model.fact_Vendedor, new { @class = "control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.EditorFor(model => model.fact_Vendedor)
                                    <span class="validation-error">@Html.ValidationMessageFor(model => model.fact_Vendedor)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-horizontal" name="Credito2" id="Credito2">
                                    @Html.LabelFor(model => model.fact_PorcentajeDescuento, new { @class = "control-label col-md-2" })
                                    <div class="col-md-4">
                                        @Html.EditorFor(model => model.fact_PorcentajeDescuento)
                                        <span class="validation-error"> @Html.ValidationMessageFor(model => model.fact_PorcentajeDescuento)</span>
                                    </div>
                                </div>
                                @Html.LabelFor(model => model.esfac_Id, new { @class = "control-label col-md-2" })
                                <div class="col-md-4">
                                    @Html.DropDownList("esfac_Id", null, new { @class = "form-control" })
                                    <span class="validation-error"> @Html.ValidationMessageFor(model => model.esfac_Id)</span>
                                </div>

                            </div>
                            <div class="form-group">
                                <div class="col-md-4">
                                    @Html.HiddenFor(model => model.clte_Id)
                                    @Html.ValidationMessageFor(model => model.clte_Id)
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-4">
                                    <input id="IDCliente" name="clte_Id" type="hidden" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-4">
                                    @Html.HiddenFor(model => model.fact_EsAnulada)
                                    @Html.ValidationMessageFor(model => model.fact_EsAnulada)
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="tabs-container">
                                        <ul class="nav nav-tabs">
                                            <li class="active"><a data-toggle="tab" href="#tab-1">Detalle factura</a></li>
                                            <li><a data-toggle="tab" href="#tab-2">Estado</a></li>
                                        </ul>
                                        <div class="tab-content">
                                            <div id="tab-1" class="tab-pane active">
                                                <div class="panel-body">
                                                    <div class="ibox-content">
                                                        @Html.Partial("_IndexFacturaDetalle", Model.tbFacturaDetalle)
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="tab-2" class="tab-pane">
                                                <div class="panel-body">
                                                    <div class="ibox-title">
                                                        <div class="ibox-tools">
                                                        </div>
                                                    </div>
                                                    @*@Html.Partial("_IndexFacturaHistorica", (List<tbFacturaHistorica>)ViewBag.FacturaHistorica)*@
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="ibox float-e-margins">
                                        <div class="ibox-title">
                                            <div class="title-action">
                                                <h5>Agregar Productos</h5>
                                                <button type="button" class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#AgregarDetalle">Nuevo</button>
                                            </div>
                                        </div>
                                        <div class="ibox-content collapse" id="AgregarDetalle">
                                            @Html.Partial("_CreateFacturaDetalleModal", new tbFacturaDetalle())
                                            <div class="form-group">
                                            </div>
                                            <br />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <div class="col-md-12 text-center">
                                            <input id="btnSave" type="submit" value="Guardar" class="btn btn-primary btn-sm" />
                                            <button id="bottonAnular" name="bottonAnular" type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#exampleModal">
                                                Anular
                                            </button>
                                            @Html.ActionLink("Cancelar", "Index", null, new { @class = "btn btn-white btn-sm" })
                                        </div>
                                    </div>
                                    <br />
                                </div>
                            </div>
                            
                        </div>
                    }
                    <div class="ibox-content">
                        <table class="table table-striped">
                            <tr>
                                <th>Acción</th>
                                <th>Usuario</th>
                                <th>Fecha</th>
                            </tr>
                            <tr>
                                <td>Creado</td>
                                <td>
                                    @Html.DisplayFor(model => model.tbUsuario.usu_Nombres)
                                    @Html.DisplayFor(model => model.tbUsuario.usu_Apellidos)
                                </td>
                                <td>@Html.DisplayFor(model => model.fact_FechaCrea)</td>
                            </tr>
                            <tr>
                                <td>Modificado</td>
                                <td>
                                    @Html.DisplayFor(model => model.tbUsuario1.usu_Nombres)
                                    @Html.DisplayFor(model => model.tbUsuario1.usu_Apellidos)
                                </td>
                                <td>@Html.DisplayFor(model => model.fact_FechaModifica)</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Anular factura</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de anular esta factura?</p>
                <textarea rows="4" cols="50" placeholder="Ingrese la razon de Anular" id="razonAnular" name="razonAnular"></textarea>
                <p id="Mensaje" style="color:red"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-sm" type="button" id="Anular">Guardar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/jquery-3.3.1.js"></script>
<script src="~/Scripts/app/FacturaDetalleEdit.js"></script>
<script src="~/Scripts/app/ProductoFactura.js"></script>
<script src="~/Scripts/app/Datepicker.js"></script>
<script src="~/Scripts/app/Credito.js"></script>
<script src="~/Scripts/app/Cantidad.js"></script>
<script src="~/Scripts/app/AutorizarDescuento.js"></script>
<script src="~/Scripts/app/AnularFactura.js"></script>
<script>
    $("#prod_CodigoBarras").on("keypress keyup blur", function (event) {
        var Value = $(this).val();
        if (Value == '') {
            $('#prod_Codigo').val('');
            $('#tbProducto_prod_Descripcion').val('');
            $('#factd_Impuesto').val(0.00);
            $('#PrecioUnitarioEdit').val(0.00);
            $('#factd_Cantidad').val(''),
            $("#PrecioUnitarioEdit").val(0.00),
            $("#SubtotalProductoEdit").val(0.00),
            $("#TotalProductoEdit").val(0.00)
            $("#Impuesto").val('')
        }
    });

    var contador = 0;
    $(document).keypress(function (e) {
        console.log('Hola', e.target.id);
        var IDInput = e.target.id;
        if (e.which == 13) {
            if (IDInput == 'prod_CodigoBarras') {
                ///
                $(function () {
                    var IDSucursal = $('#suc_Id').val();
                    var CodBarra = $('#prod_CodigoBarras').val();
                    var IDCliente = $('#clte_Id').val();
                    $.ajax({
                        type: 'POST',
                        url: '/Factura/BuscarCodigoBarras',
                        data: JSON.stringify({ IDSucursal: IDSucursal, CodBarra: CodBarra, IDCliente: IDCliente }),
                        contentType: 'application/json;',
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.length > 0) {
                            $.each(data, function (key, val) {
                                if (val.EXISTE) {
                                    console.log('each')
                                    data_producto = val.CODIGOPRODUCTO;
                                    data_descripcion = val.DESCRIPCIONPRODUCTO;
                                    data_impuesto = val.IMPUESTOPRODUCTO;
                                    data_precio = val.PRECIOUNITARIO;
                                    $('#prod_CodigoEdit').val(data_producto);
                                    $('#tbProducto_prod_DescripcionEdit').val(data_descripcion);
                                    $('#factd_ImpuestoEdit').val(data_impuesto);
                                    $('#PrecioUnitarioEdit').val(data_precio);
                                    $('#factd_CantidadEdit').val(1);


                                    var Cantidad = 1,
                                        Precio = $("#PrecioUnitarioEdit").val(),
                                        Impuesto = $("#factd_Impuesto").val(),
                                    result = "";
                                    result1 = "";
                                    if (Cantidad && Precio > 0) {
                                        result += Cantidad * Precio;
                                    }

                                    $("#SubtotalProductoEdit").val(result);
                                    Subtotal = $("#SubtotalProductoEdit").val(),
                                    PorcentajeImpuesto = ((parseFloat(Impuesto) / 100) * Subtotal);
                                    result1 += PorcentajeImpuesto;
                                    console.log(result1)
                                    $("#ImpuestoEdit").val(result1);
                                    var Descuento = $("#factd_PorcentajeDescuentoEdit").val();
                                    var Subtotal = $("#SubtotalProductoEdit").val();
                                    var impuesto = $("#factd_Impuesto").val();
                                    if (Descuento == '') {
                                        Descuento = 0
                                    }
                                    var PorcentajeDescuento = (parseFloat(Descuento) / 100);
                                    var PorcentajeImpuesto = (parseFloat(impuesto) / 100);
                                    var DescuentoTotal = (parseFloat(Subtotal) * parseFloat(PorcentajeDescuento));
                                    var impuestotal = (Subtotal * PorcentajeImpuesto);
                                    result = "";

                                    if (PorcentajeDescuento && Cantidad == '') {
                                        result += (parseFloat(Subtotal) + parseFloat(impuestotal));
                                    }
                                    else if (DescuentoTotal && Cantidad == 0) {
                                        result += (parseFloat(Subtotal) + parseFloat(impuestotal));
                                    }
                                    else {
                                        result += (parseFloat(Subtotal) - parseFloat(DescuentoTotal) + parseFloat(impuestotal));
                                    }
                                    if (Descuento == '') {
                                        $("#factd_PorcentajeDescuentoEdit").val(0);
                                    }
                                    if (Cantidad == '') {
                                        $("#factd_MontoDescuentoEdit").val('');
                                    }
                                    else {
                                        $("#factd_MontoDescuentoEdit").val(DescuentoTotal);
                                    }
                                    if (Descuento && Cantidad == '') {
                                        $("#TotalProductoEdit").val('');
                                    }
                                    else {
                                        $("#TotalProductoEdit").val(result);

                                        var CodigoProducto = $('#prod_Codigo').val();
                                        var PorcentajeDescuento = $('#factd_PorcentajeDescuentoEdit').val();
                                        var MontoDescuento = $('#factd_MontoDescuentoEdit').val();
                                        var DescripcionProducto = $('#tbProducto_prod_Descripcion').val();
                                        var CantidadProducto = $('#factd_Cantidad').val();
                                        var Subtotal = $('#SubtotalProductoEdit').val();
                                        var PrecioUnitario = $('#PrecioUnitarioEdit').val();
                                        var Impuesto = $('#factd_Impuesto').val();
                                        var Total = $('#TotalProductoEdit').val();
                                        //Prueba
                                        contador = contador + 1;
                                        copiar = "<tr data-id=" + contador + ">";
                                        copiar += "<td id = 'prod_CodigoCreate'>" + data_producto + "</td>";
                                        copiar += "<td id = 'tbProducto_prod_DescripcionCreate'>" + data_descripcion + "</td>";
                                        copiar += "<td id = 'factd_CantidadCreate' align='right'>" + 1 + "</td>";
                                        copiar += "<td id = 'Precio_UnitarioCreate' align='right'>" + data_precio + "</td>";
                                        copiar += "<td id = 'ImpuestoCreate' align='right'>" + data_impuesto + "</td>";
                                        copiar += "<td id = 'factd_MontoDescuentoEditCreate' align='right'>" + DescuentoTotal + "</td>";
                                        copiar += "<td id = 'TotalProductoEditCreate' align='right'>" + result + "</td>";
                                        copiar += "<td>" + '<button id="removeFacturaDetalle" class="btn btn-danger btn-xs eliminar" type="button">-</button>' + "</td>";
                                        copiar += "</tr>";
                                        $('#tblDetalleFactura').append(copiar);

                                        //Descuento
                                        var Descuento = $('#factd_MontoDescuentoEdit').val();
                                        var TotalDescuento = parseFloat(document.getElementById("TotalDescuento").innerHTML);

                                        if (document.getElementById("TotalDescuento").innerHTML == '') {
                                            totalProducto = $('#factd_MontoDescuentoEdit').val();
                                            document.getElementById("TotalDescuento").innerHTML = parseFloat(totalProducto);
                                        }
                                        else {
                                            document.getElementById("TotalDescuento").innerHTML = parseFloat(TotalDescuento) + parseFloat(Descuento);
                                        }

                                        //Subtotal
                                        var totalProducto = $('#SubtotalProductoEdit').val();
                                        var subtotal = parseFloat(document.getElementById("Subtotal").innerHTML);

                                        if (document.getElementById("Subtotal").innerHTML == '') {
                                            totalProducto = $('#SubtotalProductoEdit').val();
                                            document.getElementById("Subtotal").innerHTML = parseFloat(totalProducto);
                                        }
                                        else {
                                            document.getElementById("Subtotal").innerHTML = parseFloat(subtotal) + parseFloat(totalProducto);
                                        }
                                        //Impuesto
                                        var Cantidad = CantidadProducto
                                        var Precio = PrecioUnitario
                                        var impuesto = parseFloat(document.getElementById("factd_Impuesto").value.replace(',', '.'));
                                        var impuestotal = parseFloat(document.getElementById("isv").innerHTML);
                                        var porcentaje = parseFloat(impuesto / 100);
                                        var impuestos = (Cantidad * Precio) * porcentaje;
                                        console.log(impuestos)

                                        if (document.getElementById("isv").innerHTML == '') {
                                            impuesto = document.getElementById("factd_Impuesto").value;
                                            document.getElementById("isv").innerHTML = parseFloat(impuestos);
                                        }
                                        else {
                                            document.getElementById("isv").innerHTML = parseFloat(impuestotal) + parseFloat(impuestos);
                                        }

                                        //Grantotal
                                        if (document.getElementById("total").innerHTML == '') {
                                            var TotalEncabezado = document.getElementById("total").innerHTML = parseFloat(totalProducto) + parseFloat(impuestos) - parseFloat(Descuento);
                                            $("#TotalProductoEditEncabezado").val(TotalEncabezado);
                                        }
                                        else {
                                            var TotalEncabezado = document.getElementById("total").innerHTML = parseFloat(subtotal) + parseFloat(totalProducto) + parseFloat(impuestotal) + parseFloat(impuestos) - parseFloat(TotalDescuento) - parseFloat(Descuento);
                                            $("#TotalProductoEditEncabezado").val(TotalEncabezado);
                                        }

                                        var FacturaDetalle = GetFacturaDetalle();
                                        $.ajax({
                                            url: "/Factura/SaveFacturaDetalle",
                                            method: "POST",
                                            dataType: 'json',
                                            contentType: "application/json; charset=utf-8",
                                            data: JSON.stringify({ FacturaDetalleC: FacturaDetalle }),
                                        })
                                        .done(function (data) {
                                            $('#ErrorCodigoProductoCreate').text('');
                                            $('#ErrorMontoDescuentoCreate').text('');
                                            $('#ErrorCantidadCreate').text('');
                                            $('#ErrorImpuestoCreate').text('');
                                            ////Input
                                            //$('#prod_Codigo').val('');
                                            //$('#factd_MontoDescuentoEdit').val('');
                                            //$('#Impuesto').val('');
                                            //$('#tbProducto_prod_Descripcion').val('');
                                            //$('#factd_Cantidad').val('');
                                            //$('#SubtotalProductoEdit').val('');
                                            //$('#PrecioUnitarioEdit').val('');
                                            //$('#factd_Impuesto').val('');
                                            //$('#TotalProductoEdit').val('');
                                        });
                                        //Fin Prueba



                                    }

                                    if ($("#factd_Cantidad").val(), $("#PrecioUnitarioEdit").val() == '') {
                                        $("#factd_MontoDescuentoEdit").val('');
                                        $("#TotalProductoEdit").val('');
                                    }

                                }
                                else {
                                    alert("Este producto no esta en existencia.")
                                    $("#prod_CodigoBarras").val('')
                                }

                            })

                            $('#AgregarDetalleFactura').keypress(function () {
                                console.log('boton');
                                var CodigoProducto = $('#prod_Codigo').val();
                                var PorcentajeDescuento = $('#factd_PorcentajeDescuentoEdit').val();
                                var MontoDescuento = $('#factd_MontoDescuentoEdit').val();
                                var DescripcionProducto = $('#tbProducto_prod_Descripcion').val();
                                var CantidadProducto = $('#factd_Cantidad').val();
                                var Subtotal = $('#SubtotalProductoEdit').val();
                                var PrecioUnitario = $('#PrecioUnitarioEdit').val();
                                var Impuesto = $('#factd_Impuesto').val();
                                var Total = $('#TotalProductoEdit').val();

                                if (CodigoProducto == '') {
                                    $('#ErrorCodigoProductoCreate').text('');
                                    $('#ErrorMontoDescuentoCreate').text('');
                                    $('#ErrorCantidadCreate').text('');
                                    $('#ErrorImpuestoCreate').text('');
                                    $('#validationCodigoProductoCreate').after('<ul id="ErrorCodigoProductoCreate" class="validation-summary-errors text-danger">Campo Código Producto requerido</ul>');
                                }
                                else if (MontoDescuento == '') {
                                    $('#ErrorCodigoProductoCreate').text('');
                                    $('#ErrorMontoDescuentoCreate').text('');
                                    $('#ErrorCantidadCreate').text('');
                                    $('#ErrorImpuestoCreate').text('');
                                    $('#validationMontoDescuentoCreate').after('<ul id="ErrorMontoDescuentoCreate" class="validation-summary-errors text-danger">Campo Monto Descuento requerido</ul>');
                                }
                                else if (CantidadProducto == '') {
                                    $('#ErrorCodigoProductoCreate').text('');
                                    $('#ErrorMontoDescuentoCreate').text('');
                                    $('#ErrorCantidadCreate').text('');
                                    $('#ErrorImpuestoCreate').text('');
                                    $('#validationCantidadProductoCreate').after('<ul id="ErrorCantidadCreate" class="validation-summary-errors text-danger">Campo Cantidad requerido</ul>');
                                }
                                else if (Impuesto == '') {
                                    $('#ErrorCodigoProductoCreate').text('');
                                    $('#ErrorMontoDescuentoCreate').text('');
                                    $('#ErrorCantidadCreate').text('');
                                    $('#ErrorImpuestoCreate').text('');
                                    $('#validationImpuestoProductoCreate').after('<ul id="ErrorImpuestoCreate" class="validation-summary-errors text-danger">Campo Impuesto requerido</ul>');
                                }
                                else {
                                    contador = contador + 1;
                                    copiar = "<tr data-id=" + contador + ">";
                                    copiar += "<td id = 'prod_CodigoCreate'>" + CodigoProducto + "</td>";
                                    copiar += "<td id = 'tbProducto_prod_DescripcionCreate'>" + DescripcionProducto + "</td>";
                                    copiar += "<td id = 'factd_CantidadCreate' align='right'>" + CantidadProducto + "</td>";
                                    copiar += "<td id = 'Precio_UnitarioCreate' align='right'>" + PrecioUnitario + "</td>";
                                    copiar += "<td id = 'ImpuestoCreate' align='right'>" + Impuesto + "</td>";
                                    copiar += "<td id = 'factd_MontoDescuentoEditCreate' align='right'>" + MontoDescuento + "</td>";
                                    copiar += "<td id = 'TotalProductoEditCreate' align='right'>" + Total + "</td>";
                                    copiar += "<td>" + '<button id="removeFacturaDetalle" class="btn btn-danger btn-xs eliminar" type="button">-</button>' + "</td>";
                                    copiar += "</tr>";
                                    $('#tblDetalleFactura').append(copiar);
                                    //Descuento
                                    var Descuento = $('#factd_MontoDescuentoEdit').val();
                                    var TotalDescuento = parseFloat(document.getElementById("TotalDescuento").innerHTML);

                                    if (document.getElementById("TotalDescuento").innerHTML == '') {
                                        totalProducto = $('#factd_MontoDescuentoEdit').val();
                                        document.getElementById("TotalDescuento").innerHTML = parseFloat(totalProducto);
                                    }
                                    else {
                                        document.getElementById("TotalDescuento").innerHTML = parseFloat(TotalDescuento) + parseFloat(Descuento);
                                    }

                                    //Subtotal
                                    var totalProducto = $('#SubtotalProductoEdit').val();
                                    var subtotal = parseFloat(document.getElementById("Subtotal").innerHTML);

                                    if (document.getElementById("Subtotal").innerHTML == '') {
                                        totalProducto = $('#SubtotalProductoEdit').val();
                                        document.getElementById("Subtotal").innerHTML = parseFloat(totalProducto);
                                    }
                                    else {
                                        document.getElementById("Subtotal").innerHTML = parseFloat(subtotal) + parseFloat(totalProducto);
                                    }
                                    //Impuesto
                                    var Cantidad = CantidadProducto
                                    var Precio = PrecioUnitario
                                    var impuesto = parseFloat(document.getElementById("factd_Impuesto").value.replace(',', '.'));
                                    var impuestotal = parseFloat(document.getElementById("isv").innerHTML);
                                    var porcentaje = parseFloat(impuesto / 100);
                                    var impuestos = (Cantidad * Precio) * porcentaje;
                                    console.log(impuestos)

                                    if (document.getElementById("isv").innerHTML == '') {
                                        impuesto = document.getElementById("factd_Impuesto").value;
                                        document.getElementById("isv").innerHTML = parseFloat(impuestos);
                                    }
                                    else {
                                        document.getElementById("isv").innerHTML = parseFloat(impuestotal) + parseFloat(impuestos);
                                    }

                                    //Grantotal
                                    if (document.getElementById("total").innerHTML == '') {
                                        var TotalEncabezado = document.getElementById("total").innerHTML = parseFloat(totalProducto) + parseFloat(impuestos) - parseFloat(Descuento);
                                        $("#TotalProductoEditEncabezado").val(TotalEncabezado);
                                    }
                                    else {
                                        var TotalEncabezado = document.getElementById("total").innerHTML = parseFloat(subtotal) + parseFloat(totalProducto) + parseFloat(impuestotal) + parseFloat(impuestos) - parseFloat(TotalDescuento) - parseFloat(Descuento);
                                        $("#TotalProductoEditEncabezado").val(TotalEncabezado);
                                    }


                                    var FacturaDetalle = GetFacturaDetalle();
                                    $.ajax({
                                        url: "/Factura/SaveFacturaDetalle",
                                        method: "POST",
                                        dataType: 'json',
                                        contentType: "application/json; charset=utf-8",
                                        data: JSON.stringify({ FacturaDetalleC: FacturaDetalle }),
                                    })
                                    .done(function (data) {
                                        $('#ErrorCodigoProductoCreate').text('');
                                        $('#ErrorMontoDescuentoCreate').text('');
                                        $('#ErrorCantidadCreate').text('');
                                        $('#ErrorImpuestoCreate').text('');
                                        //Input
                                        $('#prod_Codigo').val('');
                                        $('#factd_MontoDescuentoEdit').val('');
                                        $('#Impuesto').val('');
                                        $('#tbProducto_prod_Descripcion').val('');
                                        $('#factd_Cantidad').val('');
                                        $('#SubtotalProductoEdit').val('');
                                        $('#PrecioUnitarioEdit').val('');
                                        $('#factd_Impuesto').val('');
                                        $('#TotalProductoEdit').val('');
                                    });
                                }
                            });
                            function GetFacturaDetalle() {

                                var FacturaDetalle = {
                                    prod_Codigo: $('#prod_Codigo').val(),
                                    factd_PorcentajeDescuentoEdit: $('#factd_PorcentajeDescuentoEdit').val(),
                                    factd_MontoDescuentoEdit: $('#factd_MontoDescuentoEdit').val(),
                                    tbProducto_prod_Descripcion: $('#tbProducto_prod_Descripcion').val(),
                                    factd_Cantidad: $('#factd_Cantidad').val(),
                                    SubtotalProductoEdit: $('#SubtotalProductoEdit').val(),
                                    PrecioUnitarioEdit: $('#PrecioUnitarioEdit').val(),
                                    factd_Impuesto: $('#factd_Impuesto').val(),
                                    TotalProductoEdit: $('#TotalProductoEdit').val(),
                                    factd_Id: contador
                                };
                                return FacturaDetalle
                            }
                        }

                    });

                    return false;
                });

                return false;
            }
            else
                return false;
        }
    });
</script>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/app/Empleados.js"></script>
}



